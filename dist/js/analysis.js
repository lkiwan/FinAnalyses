const API_BASE="https://finanalyse-api.onrender.com/api";let currentCompanyData=null;const safe=(e,t=String)=>null==e||isNaN(e)?"N/A":t(e),formatCurrencyBillion=e=>`$${(e/1e9).toFixed(1)}B`,formatPercentage=e=>`${(100*e).toFixed(1)}%`,formatRatio=e=>`${Number(e).toFixed(1)}x`;function calculateFinancialScore(e){let t=0;return e.roe>.2?t+=2:e.roe>.1&&(t+=1),e.netMargin>.15?t+=2:e.netMargin>.05&&(t+=1),e.peRatio>0&&e.peRatio<15?t+=3:e.peRatio<25?t+=2:e.peRatio<40&&(t+=1),e.debtToEquity<.5?t+=3:e.debtToEquity<1?t+=2:e.debtToEquity<2&&(t+=1),e.revenue>1e11?t+=2:e.revenue>2e10&&(t+=1),e.dividendYield>.03?t+=2:e.dividendYield>.01&&(t+=1),Math.min(10,Math.round(t/14*10*10)/10)}function generateFinancialComment(e,t){let a=`Avec un score de ${t}/10, ${e.name} `;return a+=t>=8?"présente une excellente santé financière. ":t>=6?"affiche une situation financière solide. ":t>=4?"montre une performance financière moyenne. ":"présente des défis financiers significatifs. ",e.roe>.15&&(a+=`La rentabilité sur capitaux propres est remarquable (${formatPercentage(e.roe)}). `),e.peRatio>30&&(a+=`Sa valorisation semble élevée (PER de ${e.peRatio?.toFixed(1)}). `),e.debtToEquity<1&&(a+="L'endettement est bien maîtrisé. "),a}function createComparisonRow(e,t,a,n=!1){const r=parseFloat(t),s=parseFloat(a);let o="",i="";if(!isNaN(r)&&!isNaN(s)){const e="text-green-600 font-bold",t="text-red-600";!n&&r>s||n&&r<s?(o=e,i=t):(!n&&s>r||n&&s<r)&&(i=e,o=t)}return`<tr><td class="px-2 py-2 font-medium text-gray-600">${e}</td><td class="px-2 py-2 text-center ${o}">${t}</td><td class="px-2 py-2 text-center ${i}">${a}</td></tr>`}function generateComparisonSummary(e,t){const a=[],n=[];e.peRatio&&t.peRatio&&(e.peRatio<t.peRatio?a.push("une valorisation plus attractive (PER bas)"):n.push("une valorisation plus attractive (PER bas)")),e.roe&&t.roe&&(e.roe>t.roe?a.push("une meilleure rentabilité (ROE)"):n.push("une meilleure rentabilité (ROE)")),e.netMargin&&t.netMargin&&(e.netMargin>t.netMargin?a.push("des marges plus élevées"):n.push("des marges plus élevées")),e.debtToEquity&&t.debtToEquity&&(e.debtToEquity<t.debtToEquity?a.push("un endettement mieux maîtrisé"):n.push("un endettement mieux maîtrisé"));let r=`En comparant <strong>${e.name}</strong> et <strong>${t.name}</strong>, plusieurs points ressortent.`;return a.length>0&&(r+=` <br><br><strong>${e.name}</strong> se distingue par ${a.join(", ")}.`),n.length>0&&(r+=` <br><br>À l'inverse, <strong>${t.name}</strong> montre sa force avec ${n.join(", ")}.`),r+=`<br><br><strong>Conclusion :</strong> ${a.length>n.length?`<strong>${e.name}</strong> semble présenter un profil globalement plus robuste.`:n.length>a.length?`<strong>${t.name}</strong> semble présenter un profil globalement plus attractif.`:"Les deux entreprises présentent des profils compétitifs."}`,r+='<br><br><em class="text-xs text-gray-500">Ce commentaire est généré automatiquement et ne constitue pas un conseil en investissement.</em>',r}function createChart(e,t,a,n){const r=document.getElementById(e).getContext("2d");if(!r)return null;window[e+"_instance"]&&window[e+"_instance"].destroy(),window[e+"_instance"]=new Chart(r,{type:t,data:a,options:n})}function createStat(e,t){return`<div class="bg-gray-50 p-2 rounded-lg"><p class="text-xs text-gray-500">${e}</p><p class="text-md font-semibold">${t}</p></div>`}function updateUICards(e,t,a,n){document.getElementById("company-card").innerHTML=`<h3 class="text-xl font-bold text-gray-800">${e.name}</h3><p class="text-gray-600 mb-4">${e.symbol}</p><div class="space-y-2 text-sm"><p><i class="fas fa-industry w-5 text-gray-400 mr-2"></i>${e.sector}</p><p><i class="fas fa-globe w-5 text-gray-400 mr-2"></i>${e.country}</p><p><i class="fas fa-dollar-sign w-5 text-gray-400 mr-2"></i><span class="font-semibold">${safe(e.price,e=>`$${e.toFixed(2)}`)}</span></p></div>`;const r=a/10*120;document.getElementById("score-card").innerHTML=`<h3 class="text-lg font-semibold text-gray-800 mb-2 text-center">Score Financier</h3><div class="text-center my-4"><span class="text-5xl font-bold" style="color: hsl(${r}, 80%, 45%)">${a.toFixed(1)}</span><span class="text-2xl text-gray-500">/10</span></div><p class="text-xs text-gray-600 text-center">${n.split(". ")[1]||""}</p>`,document.getElementById("analysis-comment").textContent=n,document.getElementById("quick-stats-card").innerHTML=`<h3 class="text-lg font-semibold text-gray-800 mb-4">Indicateurs Clés</h3><div class="grid grid-cols-2 gap-2">${createStat("Chiffre d'affaires",safe(e.revenue,formatCurrencyBillion))}${createStat("Bénéfice net",safe(e.netIncome,formatCurrencyBillion))}${createStat("PER",safe(e.peRatio,e=>e.toFixed(1)))}${createStat("ROE",safe(e.roe,formatPercentage))}${createStat("Marge nette",safe(e.netMargin,formatPercentage))}${createStat("Dividende (Yield)",safe(t.dividendYield,formatPercentage))}</div>`,document.getElementById("advanced-metrics-grid").innerHTML=`\n        ${createStat("Ratio de liquidité",safe(t.currentRatio,e=>e.toFixed(2)))}\n        ${createStat("Liquidité rapide",safe(t.quickRatio,e=>e.toFixed(2)))}\n        ${createStat("Dette/Cap. Propres",safe(t.debtToEquity,e=>e.toFixed(2)))}\n        ${createStat("Couv. des intérêts",safe(t.interestCoverage,formatRatio))}\n        ${createStat("Free Cash Flow",safe(t.freeCashFlow,formatCurrencyBillion))} \n    `}async function analyzeCompany(e){const t=document.getElementById("loading-state"),a=document.getElementById("analysis-content"),n=document.getElementById("error-state"),r=document.getElementById("error-message");t.classList.remove("hidden"),a.classList.add("hidden"),n.classList.add("hidden");try{const[t,n,r,s]=await Promise.all([fetch(`${API_BASE}/entreprise/${e}`),fetch(`${API_BASE}/historique/${e}`),fetch(`${API_BASE}/advanced-metrics/${e}`),fetch(`${API_BASE}/dividends/${e}`)]);if(!t.ok)throw new Error((await t.json()).detail||"Données financières non trouvées.");const o=await t.json(),i=await n.json(),d=await r.json(),c=await s.json();currentCompanyData={...o,...d};const l=calculateFinancialScore(currentCompanyData),m=generateFinancialComment(o,l);document.title=`${o.name} (${o.symbol}) - FinAnalyse`,document.getElementById("analysis-title").textContent=`Analyse de ${o.name}`,updateUICards(o,d,l,m),createChart("stock-chart","line",{labels:i.dates,datasets:[{label:"Prix ($)",data:i.prices,borderColor:"#3b82f6",fill:!0,backgroundColor:"rgba(59, 130, 246, 0.1)"}]},{responsive:!0,maintainAspectRatio:!1}),createChart("dividend-chart","bar",{labels:c.dividendHistory.years,datasets:[{label:"Dividende Annuel ($)",data:c.dividendHistory.amounts,backgroundColor:"#10b981"}]},{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}}}),a.classList.remove("hidden")}catch(e){n.classList.remove("hidden"),r.textContent=`Erreur : ${e.message}. Vérifiez le symbole et réessayez.`,document.title="Erreur - FinAnalyse"}finally{t.classList.add("hidden")}}document.addEventListener("DOMContentLoaded",()=>{const e=new URLSearchParams(window.location.search).get("ticker");if(e)analyzeCompany(e.toUpperCase());else{document.getElementById("loading-state").classList.add("hidden");document.getElementById("error-state").classList.remove("hidden"),document.getElementById("error-message").innerHTML='Aucun symbole boursier fourni. <a href="index.html" class="font-bold underline">Retour à l\'accueil</a>.',document.title="Aucune entreprise - FinAnalyse"}document.getElementById("run-screener").addEventListener("click",async()=>{const e=document.getElementById("screener-results");e.innerHTML='<p class="text-sm text-gray-500">Recherche en cours...</p>',e.classList.remove("hidden");const t=new URLSearchParams({sector:document.getElementById("sector-select").value,pe_max:document.getElementById("pe-max").value,dividend_min:document.getElementById("dividend-min").value}),a=await fetch(`${API_BASE}/screener?${t.toString()}`),n=(await a.json()).results.map(e=>`<tr><td class="px-4 py-2"><a href="#" onclick="analyzeCompany('${e.symbol}')" class="text-blue-600 hover:underline">${e.symbol}</a></td><td class="px-4 py-2">${e.name}</td><td class="px-4 py-2">${safe(e.pe,e=>e.toFixed(1))}</td><td class="px-4 py-2">${safe(e.dividendYield,formatPercentage)}</td></tr>`).join("");e.innerHTML=`<table class="min-w-full text-sm text-left"><thead><tr class="bg-gray-50"><th class="px-4 py-2">Sym.</th><th class="px-4 py-2">Nom</th><th class="px-4 py-2">PER</th><th class="px-4 py-2">Dividende</th></tr></thead><tbody>${n}</tbody></table>`}),document.getElementById("add-to-comparison").addEventListener("click",async()=>{const e=document.getElementById("compare-ticker").value.trim().toUpperCase();if(!e||!currentCompanyData)return void alert("Veuillez d'abord analyser une entreprise et entrer un symbole à comparer.");const t=document.getElementById("comparison-container"),a=document.getElementById("comparison-summary");a.innerHTML="Chargement des données de comparaison...",t.classList.remove("hidden");try{const[t,n]=await Promise.all([fetch(`${API_BASE}/entreprise/${e}`),fetch(`${API_BASE}/advanced-metrics/${e}`)]);if(!t.ok)throw new Error((await t.json()).detail);const r=await t.json(),s=await n.json(),o={...r,...s};let i=`<table class="min-w-full text-sm text-left"><thead class="bg-gray-50"><tr><th class="px-2 py-2">Métrique</th><th class="px-2 py-2 text-center font-semibold">${currentCompanyData.symbol}</th><th class="px-2 py-2 text-center font-semibold">${o.symbol}</th></tr></thead><tbody>`;i+=createComparisonRow("PER",safe(currentCompanyData.peRatio,e=>e.toFixed(1)),safe(o.peRatio,e=>e.toFixed(1)),!0),i+=createComparisonRow("ROE",safe(currentCompanyData.roe,formatPercentage),safe(o.roe,formatPercentage)),i+=createComparisonRow("Marge Nette",safe(currentCompanyData.netMargin,formatPercentage),safe(o.netMargin,formatPercentage)),i+=createComparisonRow("Dette/Cap. Propres",safe(currentCompanyData.debtToEquity,e=>e.toFixed(2)),safe(o.debtToEquity,e=>e.toFixed(2)),!0),i+=createComparisonRow("Dividende (Yield)",safe(currentCompanyData.dividendYield,formatPercentage),safe(o.dividendYield,formatPercentage)),i+="</tbody></table>",document.getElementById("comparison-table-container").innerHTML=i,a.innerHTML=generateComparisonSummary(currentCompanyData,o)}catch(e){alert("Erreur comparaison : "+e.message),t.classList.add("hidden")}})});